package edu.rit.se.nvip.model;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.sql.Timestamp;
import java.time.Clock;
import java.time.Instant;
import java.util.HashSet;
import java.util.LinkedHashSet;
import java.util.Set;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

class CompositeVulnerabilityTest {

    private final Clock mockClock;
    private final long dummyMillis;
    private final String dummyCveId;
    private final int dummyId;
    private final String dummyDescription;
    private final Timestamp dummyPub;
    private final Timestamp dummyMod;
    private final Timestamp dummyCreate;
    private final Timestamp dummyDescCreate;
    private final String dummyBuildString;


    CompositeVulnerabilityTest() {
        this.dummyCveId = "CVE-xxxx-xxx";
        this.dummyId = 1;
        this.dummyDescription = "dummy description";
        this.dummyMillis = Instant.now().toEpochMilli();
        this.dummyPub = offset(0);
        this.dummyMod = offset(3);
        this.dummyCreate = offset(2);
        this.dummyDescCreate = offset(4);
        this.dummyBuildString = "((1,2),3)";
        this.mockClock = mock(Clock.class);
        CompositeDescription.setClock(mockClock);
        CompositeVulnerability.setClock(mockClock);
    }

    @BeforeEach
    void resetMocks() {
        when(mockClock.millis()).thenReturn(dummyMillis);
    }

    private RawVulnerability genRawVuln(int id) {
        return new RawVulnerability(id, dummyCveId, "description"+id, offset(-id), offset(id), offset(-10), "website"+id );
    }
    private Set<RawVulnerability> genRawVulns(int size, int startId) {
        Set<RawVulnerability> out = new LinkedHashSet<>();
        for (int i = 0; i < size; i++) {
            out.add(genRawVuln(i+startId));
        }
        return out;
    }

    private CompositeDescription genCompDes(String buildString, int nSources) {
        return new CompositeDescription(dummyId, dummyCveId, dummyDescription, dummyDescCreate, buildString, genRawVulns(nSources, 1));
    }


    private CompositeVulnerability genVuln() {
        return new CompositeVulnerability(dummyCveId, dummyId, genCompDes(dummyBuildString, 3), dummyPub, dummyMod, dummyCreate);
    }

    private Timestamp offset(int nHours) {
        return new Timestamp(dummyMillis + nHours*3600L*1000);
    }

    @Test
    void constructorFromFields() {
        CompositeVulnerability vuln = genVuln();
        assertEquals(CompositeVulnerability.ReconciliationStatus.UNCHANGED, vuln.getReconciliationStatus());
        assertEquals(dummyCveId, vuln.getCveId());
        assertEquals(dummyDescription, vuln.getDescription());
        assertEquals(offset(-3), vuln.getPublishDate());
        assertEquals(offset(3), vuln.getLastModifiedDate());
        assertEquals(dummyCreate, vuln.getCreateDate());
        assertEquals(3, vuln.getComponents().size());
        assertEquals(3, vuln.getSources().size());
        assertEquals(1, vuln.getDescriptionId());
        assertEquals("((1,2),3)", vuln.getBuildString());
        assertEquals(dummyDescCreate, vuln.getDescriptionCreateDate());
    }

    @Test
    void constructorFromRaw() {
        CompositeVulnerability vuln = new CompositeVulnerability(genRawVuln(4));
        assertEquals(CompositeVulnerability.ReconciliationStatus.NEW, vuln.getReconciliationStatus());
        assertEquals(dummyCveId, vuln.getCveId());
        assertEquals("description4", vuln.getDescription());
        assertEquals(offset(-4), vuln.getPublishDate());
        assertEquals(offset(4), vuln.getLastModifiedDate());
        assertEquals(offset(-10), vuln.getCreateDate());
        assertEquals(1, vuln.getComponents().size());
        assertEquals(1, vuln.getSources().size());
        assertEquals(0, vuln.getDescriptionId());
        assertEquals("4", vuln.getBuildString());
        assertEquals(offset(0), vuln.getDescriptionCreateDate());
    }

    @Test
    void fromSet() {
        CompositeVulnerability vuln = CompositeVulnerability.fromSet(genRawVulns(5, 1), "reconciled description");
        assertEquals(CompositeVulnerability.ReconciliationStatus.NEW, vuln.getReconciliationStatus());
        assertEquals(dummyCveId, vuln.getCveId());
        assertEquals("reconciled description", vuln.getDescription());
        assertEquals(offset(-5), vuln.getPublishDate());
        assertEquals(offset(5), vuln.getLastModifiedDate());
        assertEquals(offset(0), vuln.getCreateDate());
        assertEquals(5, vuln.getComponents().size());
        assertEquals(5, vuln.getSources().size());
        assertEquals(0, vuln.getDescriptionId());
        assertEquals("(1,2,3,4,5)", vuln.getBuildString());
        assertEquals(offset(0), vuln.getDescriptionCreateDate());

    }

    @Test
    void getComponents() {
        CompositeVulnerability vuln = genVuln();
        Set<RawVulnerability> rawVulns = vuln.getComponents();
        assertEquals(3, rawVulns.size());
    }

    @Test
    void getReconciliationStatus() {
        CompositeVulnerability vuln = genVuln();
        assertEquals(CompositeVulnerability.ReconciliationStatus.UNCHANGED, vuln.getReconciliationStatus());
        vuln.updateDescription("new description", new HashSet<>(), false);
        assertEquals(CompositeVulnerability.ReconciliationStatus.UPDATED, vuln.getReconciliationStatus());
        vuln = genVuln();
        vuln.updateDescription(dummyDescription, new HashSet<>(), false);
        assertEquals(CompositeVulnerability.ReconciliationStatus.UNCHANGED, vuln.getReconciliationStatus());
    }

    @Test
    void getSources() {
        CompositeVulnerability vuln = genVuln();
        Set<String> sources = vuln.getSources();
        assertEquals(3, sources.size());
        assertTrue(sources.contains("website1"));
        assertTrue(sources.contains("website2"));
        assertTrue(sources.contains("website3"));
    }

    @Test
    void updateDescriptionNoResynth() {
        CompositeVulnerability vuln = genVuln();
        vuln.updateDescription("updated description", genRawVulns(3, 4), false);
        assertEquals(vuln.getReconciliationStatus(), CompositeVulnerability.ReconciliationStatus.UPDATED);
        assertEquals("updated description", vuln.getDescription());
        assertEquals("(((1,2),3),4,5,6)", vuln.getBuildString());
        assertEquals(6, vuln.getComponents().size());
    }

    @Test
    void updateDescriptionResynth() {
        CompositeVulnerability vuln = genVuln();
        vuln.updateDescription("updated description", genRawVulns(3, 4), true);
        assertEquals(vuln.getReconciliationStatus(), CompositeVulnerability.ReconciliationStatus.UPDATED);
        assertEquals("updated description", vuln.getDescription());
        assertEquals("(1,2,3,4,5,6)", vuln.getBuildString());
        assertEquals(6, vuln.getComponents().size());
    }

    @Test
    void updateDescriptionNoEffect() {
        CompositeVulnerability vuln = genVuln();
        vuln.updateDescription(dummyDescription, new HashSet<>(), true);
        assertEquals(CompositeVulnerability.ReconciliationStatus.UNCHANGED, vuln.getReconciliationStatus());
    }

    @Test
    void setDescriptionId() {
        CompositeVulnerability vuln = genVuln();
        vuln.setDescriptionId(10);
        assertEquals(10, vuln.getDescriptionId());
        vuln.setDescriptionId(20);
        assertEquals(20, vuln.getDescriptionId());
    }

    @Test
    void getDescriptionId() {
        CompositeVulnerability vuln = genVuln();
        vuln.setDescriptionId(10);
        assertEquals(10, vuln.getDescriptionId());
        vuln.setDescriptionId(20);
        assertEquals(20, vuln.getDescriptionId());
    }

    @Test
    void getBuildString() {
        CompositeVulnerability vuln = genVuln();
        assertEquals(dummyBuildString, vuln.getBuildString());
        vuln.updateDescription("", genRawVulns(2, 4), false);
        assertEquals("(((1,2),3),4,5)", vuln.getBuildString());
        vuln.updateDescription("", genRawVulns(5, 6), true);
        assertEquals("(1,2,3,4,5,6,7,8,9,10)", vuln.getBuildString());
    }

    @Test
    void getDescriptionCreateDate() {
        CompositeVulnerability vuln = genVuln();
        assertEquals(dummyDescCreate, vuln.getDescriptionCreateDate());
        when(mockClock.millis()).thenReturn(dummyMillis + 3600L);
        vuln.updateDescription("", genRawVulns(2,4), false);
        assertEquals(new Timestamp(dummyMillis+3600L), vuln.getDescriptionCreateDate());
        when(mockClock.millis()).thenReturn(dummyMillis+7200L);
        vuln.updateDescription("", genRawVulns(4, 6), true);
        assertEquals(new Timestamp(dummyMillis+7200L), vuln.getDescriptionCreateDate());
    }

    @Test
    void getDescription() {
        CompositeVulnerability vuln = genVuln();
        assertEquals(dummyDescription, vuln.getDescription());
        vuln.updateDescription("new description", new HashSet<>(), false);
        assertEquals("new description", vuln.getDescription());
        vuln.updateDescription("new new description", new HashSet<>(), true);
        assertEquals("new new description", vuln.getDescription());
    }

    @Test
    void getPublishDate() {
        CompositeVulnerability vuln = genVuln();
        assertEquals(offset(-3), vuln.getPublishDate());
        vuln.updateDescription("", genRawVulns(1, 20), false);
        assertEquals(offset(-20), vuln.getPublishDate());
        vuln.updateDescription("", genRawVulns(1, 10), false);
        assertEquals(offset(-20), vuln.getPublishDate());
    }

    @Test
    void getLastModifiedDate() {
        CompositeVulnerability vuln = genVuln();
        assertEquals(offset(3), vuln.getLastModifiedDate());
        vuln.updateDescription("", genRawVulns(1, 20), false);
        assertEquals(offset(20), vuln.getLastModifiedDate());
        vuln.updateDescription("", genRawVulns(1, 10), false);
        assertEquals(offset(20), vuln.getLastModifiedDate());
    }
}