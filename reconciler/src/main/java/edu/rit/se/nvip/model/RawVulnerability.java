package edu.rit.se.nvip.model;

import edu.rit.se.nvip.filter.FilterStatus;

import java.sql.Timestamp;
import java.util.Arrays;
import java.util.Objects;

/**
 * Simple model to represent a RawVulnerability (a row in the rawdescriptions table)
 */
public class RawVulnerability extends Vulnerability{

    private final String sourceUrl;
    private final int id;
    private final SourceType sourceType;
    private FilterStatus filterStatus;
    private boolean filterStatusChanged = false;

    public RawVulnerability(int id, String cveId, String description, Timestamp publishDate, Timestamp lastModifiedDate, Timestamp createDate, String sourceUrl, String sourceType, int filterStatus) {
        super(cveId, description, publishDate, lastModifiedDate, createDate);
        this.id = id;
        this.sourceUrl = sourceUrl;
        this.sourceType = SourceType.get(sourceType);
        this.filterStatus = FilterStatus.get(filterStatus);
    }

    /**
     * Constructor just missing the sourceType arg. This exists so I don't need to update dozens of tests
     * // todo dump this constructor
     * @param id
     * @param cveId
     * @param description
     * @param publishDate
     * @param lastModifiedDate
     * @param createDate
     * @param sourceUrl
     */
    public RawVulnerability(int id, String cveId, String description, Timestamp publishDate, Timestamp lastModifiedDate, Timestamp createDate, String sourceUrl) {
        super(cveId, description, publishDate, lastModifiedDate, createDate);
        this.id = id;
        this.sourceUrl = sourceUrl;
        this.sourceType = SourceType.OTHER;
        this.filterStatus = FilterStatus.UNEVALUATED;
    }

    public SourceType getSourceType() {
        return this.sourceType;
    }

    /**
     * return boolean if Raw Vulnerability is high priority
     * @return
     */
    public boolean isHighPriority() {
        return this.sourceType == SourceType.CNA || this.sourceType == SourceType.SA || this.sourceType == SourceType.USER;
    }

    public int getSourcePriority() {
        return this.sourceType.priority;
    }

    public FilterStatus getFilterStatus() {
        return this.filterStatus;
    }

    public void setFilterStatus(FilterStatus filterStatus) {
        if (this.filterStatus != filterStatus) {
            this.filterStatusChanged = true;
        }
        this.filterStatus = filterStatus;
    }

    public boolean filterStatusChanged() {
        return this.filterStatusChanged;
    }

    public boolean isFiltered() {
        return this.filterStatus == FilterStatus.PASSED || this.filterStatus == FilterStatus.FAILED;
    }

    public String getSourceUrl() {
        return sourceUrl;
    }

    public int getId() {
        return this.id;
    }

    public String getIdString() {
        return String.valueOf(this.id);
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        RawVulnerability that = (RawVulnerability) o;
        return id == that.id;
    }

    public boolean generalEquals(RawVulnerability other) {
        return (this.getCveId().equals(other.getCveId()) &&
                this.getDescription().equals(other.getDescription()) &&
                this.getSourceUrl().equals(other.getSourceUrl()));
    }

    public String descForFilter() {
        return this.getDescription().trim();
    }

    public boolean equivalentUnderFiltering(RawVulnerability other) {
        // this is just checking if trimmed descriptions are the same, but could involve other fields such as source type/priority
        return this.descForFilter().equals(other.descForFilter());
    }

    @Override
    public int hashCode() {
        return Objects.hash(id);
    }
}
