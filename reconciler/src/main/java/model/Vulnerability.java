package model;

import java.sql.Timestamp;
import java.text.DecimalFormat;
import java.text.NumberFormat;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;


/**
 * Simple model to represent all fields shared between a RawVulnerability and a CompositeVulnerability
 */
public class Vulnerability {
    protected final NumberFormat formatter = new DecimalFormat("#0.00");
    protected final DateTimeFormatter dateTimeFormatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

    protected int vulnID = 0;
    protected String cveId = null; // CVE ID
    protected String description = null; // CVE description text
    protected String platform = null; // Related platform/program and version info
    protected String patch = null; // Link to patch
    protected Timestamp publishDate = null; // The date time it is published
    protected Timestamp createDate = null; // The time the entry is created at NVIP DB
    protected Timestamp lastModifiedDate = null; // The most recent crawl date
    protected String fixDate = null; // The time the vulnerability was fixed (a patch published?)

    // 0 means not in ndv/mitre, 1 means it exists in nvd/mitre
    protected int statusNvd = 0; // this CVE-ID exists in NVD feeds?
    protected int statusMitre = 0;// this CVE-ID exists in MITRE feeds?

    /**
     * The time gap (hours) between the time NVIP has crawled this and the time it
     * was available at Nvd/Mitre
     */
    protected int timeGapNvd = 0;
    protected int timeGapMitre = 0;
    /**
     * CVE is reserved/rejected etc. in MITRE, but nvip crawlers found new
     * description for it! By default, the value is false.
     */
    protected boolean foundNewDescriptionForReservedCve = false;

    public Vulnerability() {}

    /**
     * For comparing w/ NVD
     * @param cveId
     * @param publishDate
     */

    public Vulnerability(String cveId, Timestamp publishDate) {
        this.cveId = cveId;
        this.publishDate = publishDate;
    }


    public Vulnerability(String cveId, String description, Timestamp publishDate, Timestamp lastModifiedDate, Timestamp createDate) {
        this.cveId = cveId;
        this.description = description;
        this.publishDate = publishDate;
        this.lastModifiedDate = lastModifiedDate;
        this.createDate = createDate;
    }

    /**
     * Constructor for vulnerability updates
     *
     * @param vuln_id
     * @param description
     * @param existAtNvd
     * @param existAtMitre
     * @param createdDate
     */
    public Vulnerability(int vuln_id, String cveId, String description, int existAtNvd, int existAtMitre, Timestamp createdDate) {
        this.vulnID = vuln_id;
        this.description = description;
        this.cveId = cveId;
        this.statusNvd = existAtNvd;
        this.statusMitre = existAtMitre;
        if (createdDate != null) {
            this.createDate = createdDate;
        } else {
            this.createDate = Timestamp.valueOf(LocalDateTime.now().format(dateTimeFormatter));
        }
    }
    public int getVulnID() {
        return vulnID;
    }

    public String getCveId() {
        return cveId;
    }

    public void setCVEID(String cveID) {
        this.cveId = cveID;
    }

    public String getPlatform() {
        return platform;
    }

    public void setPlatform(String platform) {
        this.platform = platform;
    }

    public Timestamp getPublishDate() {
        return publishDate;
    }

    public void setPublishDate(Timestamp publishDate) {
        this.publishDate = publishDate;
    }

    public Timestamp getLastModifiedDate() { return lastModifiedDate; }

    public void setLastModifiedDate(Timestamp lastModifiedDate) {
        this.lastModifiedDate = lastModifiedDate;
    }

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }

    public boolean doesExistInNvd() {
        return statusNvd > 0;
    }

    public void setNvdStatus(int statusNvd) {
        this.statusNvd = statusNvd;
    }

    public boolean doesExistInMitre() {
        return statusMitre > 0;
    }

    public void setMitreStatus(int statusMitre) {
        this.statusMitre = statusMitre;
    }

    public void setCveId(String cveId) {
        this.cveId = cveId;
    }

    public String getPatch() {
        return patch;
    }

    public void setPatch(String patch) {
        this.patch = patch;
    }

    public Timestamp getCreateDate() { return createDate; }

    public LocalDateTime getCreatedDateAsDate() {
        return LocalDateTime.parse((CharSequence) this.createDate, dateTimeFormatter);
    }
    public void setCreateDate(Timestamp createDate) {
        this.createDate = createDate;
    }

    public String getFixDate() {
        return fixDate;
    }

    public void setFixDate(String fixDate) {
        this.fixDate = fixDate;
    }

    public int getTimeGapNvd() {
        return timeGapNvd;
    }

    public void setTimeGapNvd(int timeGapNvd) {
        this.timeGapNvd = timeGapNvd;
    }

    public int getTimeGapMitre() {
        return timeGapMitre;
    }

    public void setTimeGapMitre(int timeGapMitre) {
        this.timeGapMitre = timeGapMitre;
    }

    public int getNvdStatus() {
        return statusNvd;
    }

    public int getMitreStatus() {
        return statusMitre;
    }

    public boolean isFoundNewDescriptionForReservedCve() {
        return foundNewDescriptionForReservedCve;
    }

    public void setFoundNewDescriptionForReservedCve(boolean reservedCveHasNewDescription) {
        this.foundNewDescriptionForReservedCve = reservedCveHasNewDescription;
    }


}
