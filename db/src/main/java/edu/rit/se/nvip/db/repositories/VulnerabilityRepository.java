package edu.rit.se.nvip.db.repositories;

import edu.rit.se.nvip.db.DatabaseHelper;
import edu.rit.se.nvip.db.model.CompositeDescription;
import edu.rit.se.nvip.db.model.CompositeVulnerability;
import edu.rit.se.nvip.db.model.RawVulnerability;
import edu.rit.se.nvip.db.model.Vulnerability;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.sql.DataSource;
import java.sql.*;
import java.util.HashMap;
import java.util.Map;
import java.util.Set;

@Slf4j
@RequiredArgsConstructor
public class VulnerabilityRepository {

    private final DataSource dataSource;

    private final String selectCVEIdSql = "SELECT cve_id FROM vulnerability WHERE vuln_id = ?";

    public CompositeVulnerability getCompositeVulnerability(String cveId) {
        RawDescriptionRepository rawRepo = new RawDescriptionRepository(this.dataSource);
        Set<RawVulnerability> usedRawVulns = rawRepo.getUsedRawVulnerabilities(cveId);
        return getSummaryVulnerability(cveId, usedRawVulns);
    }

    private String getCompVuln = "SELECT v.created_date, vv.published_date, vv.last_modified_date, d.description_id, d.description, d.created_date AS description_date, d.gpt_func " +
            "FROM vulnerability AS v " +
            "INNER JOIN vulnerabilityversion AS vv ON v.vuln_version_id = vv.vuln_version_id " +
            "INNER JOIN description AS d ON vv.description_id = d.description_id " +
            "WHERE v.cve_id = ?";

    // very hacky to use the rawVulns as an arg, there's a better way to handle this join
    private CompositeVulnerability getSummaryVulnerability(String cveId, Set<RawVulnerability> rawVulns) {
        CompositeVulnerability vuln = null;
        try (Connection conn = dataSource.getConnection(); PreparedStatement pstmt = conn.prepareStatement(getCompVuln)) {
            pstmt.setString(1, cveId);
            ResultSet res = pstmt.executeQuery();
            if (res.next()) {
                CompositeDescription compDes = new CompositeDescription(
                        res.getInt("description_id"),
                        cveId,
                        res.getString("description"),
                        res.getTimestamp("description_date"),
                        res.getString("gpt_func"),
                        rawVulns
                );
                vuln = new CompositeVulnerability(
                        cveId,
                        res.getInt("vuln_id"),
                        compDes,
                        res.getTimestamp("published_date"),
                        res.getTimestamp("last_modified_date"),
                        res.getTimestamp("created_date")
                );
            }
        } catch (SQLException ex) {
            log.error("Error retrieving vulnerability {}.\n{}", cveId, ex);
            return null;
        }
        return vuln;
    }

    /**
     * Collect a CVE ID from the Vulnerability table by Vuln ID
     *
     * @param vulnId
     * @return
     */
    public String getCveId(String vulnId) {

        String cve_id = "";

        try (Connection connection = dataSource.getConnection()) {

            PreparedStatement pstmt = connection.prepareStatement(selectCVEIdSql);
            pstmt.setInt(1, Integer.parseInt(vulnId));
            ResultSet rs = pstmt.executeQuery();

            if (rs.next()) {
                cve_id = rs.getString("cve_id");
            }
        } catch (Exception e) {
            log.error(e.toString());
        }

        return cve_id;
    }


    private static final String INSERT_DESCRIPTION = "INSERT INTO description (description, created_date, gpt_func, cve_id, is_user_generated) VALUES (?, ?, ?, ?, ?)";
    private static final String INSERT_JT = "INSERT INTO rawdescriptionjt (description_id, raw_description_id) VALUES (?, ?)";
    private static final String INSERT_VULN_VERSION = "INSERT INTO vulnerabilityversion (cve_id, description_id, created_date, published_date, last_modified_date) VALUES (?, ?, NOW(), ?, ?)";
    private static final String COPY_PREV_VERSION_KEYS = "UPDATE vulnerabilityversion SET vdo_set_id = (SELECT vdo_set_id FROM vulnerabilityversion WHERE cve_id = ? ORDER BY created_date DESC LIMIT 1), " +
            "cpe_set_id = (SELECT cpe_set_id FROM vulnerabilityversion WHERE cve_id = ? ORDER BY created_date DESC LIMIT 1) WHERE vuln_version_id = ?";
    private static final String INSERT_VULNERABILITY = "INSERT INTO vulnerability (cve_id, created_date, vuln_version_id) VALUES (?, NOW(), ?)";
    private static final String UPDATE_VULNERABILITY = "UPDATE vulnerability SET vuln_version_id = ? WHERE cve_id = ?";
    private static final String DELETE_JOB = "DELETE FROM cvejobtrack WHERE cve_id = ?";


    /**
     * Inserts, updates, or does nothing for a composite vulnerability based on its reconciliation status
     * @param vuln composite vulnerability
     * @return 1 if inserted/updated, 0 if skipped, -1 if error
     */
    public int insertOrUpdateVulnerabilityFull(CompositeVulnerability vuln) {
        boolean isUpdate;
        switch (vuln.getReconciliationStatus()) {
            case UPDATED:
                isUpdate = true;
                break;
            case NEW:
                isUpdate = false;
                break;
            default:
                return 0;
        }


        try (Connection conn = dataSource.getConnection();
             PreparedStatement descriptionStatement = conn.prepareStatement(INSERT_DESCRIPTION, Statement.RETURN_GENERATED_KEYS);
             PreparedStatement jtStatement = conn.prepareStatement(INSERT_JT);
             PreparedStatement vvStatement = conn.prepareStatement(INSERT_VULN_VERSION, Statement.RETURN_GENERATED_KEYS);
             PreparedStatement copyStatement = conn.prepareStatement(COPY_PREV_VERSION_KEYS);
             PreparedStatement vulnStatement = conn.prepareStatement(isUpdate ? UPDATE_VULNERABILITY : INSERT_VULNERABILITY);
             PreparedStatement jobStatement = conn.prepareStatement(DELETE_JOB)) {
            // handle all these atomically
            conn.setAutoCommit(false);
            // insert into description table
            populateDescriptionInsert(descriptionStatement, vuln.getSystemDescription());
            descriptionStatement.executeUpdate();
            // get generated description id
            ResultSet rs = descriptionStatement.getGeneratedKeys();
            if (rs.next()) {
                vuln.setDescriptionId(rs.getInt(1));
            } else {
                // Pretty sure an exception would have been thrown by now anyway, but just in case...
                log.error("ERROR: Failure in inserting to the description table");
                throw new SQLException();
            }
            // batch insert into joint table
            for (RawVulnerability rawVuln : vuln.getComponents()) {
                populateJTInsert(jtStatement, vuln.getSystemDescription(), rawVuln);
                jtStatement.addBatch();
            }
            jtStatement.executeBatch();
            // insert new version row
            populateVulnVersionInsert(vvStatement, vuln);
            vvStatement.executeUpdate();
            rs = vvStatement.getGeneratedKeys();
            if (rs.next()) {
                vuln.setVersionId(rs.getInt(1));
            }
            // if we're updating, copy over the vdo/cpe pointers to this new version
            if (isUpdate) {
                populateCopyStatement(copyStatement, vuln);
                copyStatement.executeUpdate();
            }
            // insert new vuln row or update version pointer
            if (isUpdate) {
                populateVulnUpdate(vulnStatement, vuln);
            } else {
                populateVulnInsert(vulnStatement, vuln);
            }
            vulnStatement.executeUpdate();
            // remove job
            populateJobDelete(jobStatement, vuln);
            jobStatement.executeUpdate();
            // execute atomically
            conn.commit();
        } catch (SQLException ex) {
            log.error("ERROR while {} {}.\n{}", isUpdate ? "updating" : "inserting", vuln.getCveId(), ex);
            return -1;
        }
        return 1;
    }

    private void populateDescriptionInsert(PreparedStatement descriptionStatement, CompositeDescription compDesc) throws SQLException {
        descriptionStatement.setString(1, compDesc.getDescription());
        descriptionStatement.setTimestamp(2, compDesc.getCreatedDate());
        descriptionStatement.setString(3, compDesc.getBuildString());
        descriptionStatement.setString(4, compDesc.getCveId());
        descriptionStatement.setInt(5, compDesc.isUserGenerated() ? 1 : 0);
    }

    private void populateJTInsert(PreparedStatement jtStatement, CompositeDescription compDesc, RawVulnerability rawVuln) throws SQLException {
        jtStatement.setInt(1, compDesc.getId());
        jtStatement.setInt(2, rawVuln.getId());
    }

    private void populateVulnInsert(PreparedStatement vulnStatement, CompositeVulnerability vuln) throws SQLException {
        vulnStatement.setString(1, vuln.getCveId());
        vulnStatement.setInt(2, vuln.getVersionId());
    }

    private void populateVulnUpdate(PreparedStatement vulnStatement, CompositeVulnerability vuln) throws SQLException {
        vulnStatement.setInt(1, vuln.getVersionId());
        vulnStatement.setString(2, vuln.getCveId());
    }

    private void populateVulnVersionInsert(PreparedStatement vvStatement, CompositeVulnerability vuln) throws SQLException{
        vvStatement.setString(1, vuln.getCveId());
        vvStatement.setInt(2, vuln.getDescriptionId());
        vvStatement.setTimestamp(3, vuln.getPublishDate());
        vvStatement.setTimestamp(4, vuln.getLastModifiedDate());
    }

    private void populateCopyStatement(PreparedStatement copyStatement, CompositeVulnerability vuln) throws SQLException{
        copyStatement.setString(1, vuln.getCveId());
        copyStatement.setString(2, vuln.getCveId());
        copyStatement.setInt(3, vuln.getVersionId());
    }

    private void populateJobDelete(PreparedStatement jobStatement, CompositeVulnerability vuln) throws SQLException {
        jobStatement.setString(1, vuln.getCveId());
    }
}
