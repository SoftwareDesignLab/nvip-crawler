<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:pro="http://www.liquibase.org/xml/ns/pro" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-latest.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">
    
    <changeSet author="vulnerability" id="vulnerability">
        <createTable tableName="vulnerability">
            <column name="vuln_id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cve_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="description_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="published_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex
            indexName="vuln_id_UNIQUE"
            tableName="vulnerability"
            unique="true">
            <column name="vuln_id"/>
        </createIndex>

         <createIndex
            indexName="vulnerability_index_cve_id"
            tableName="vulnerability"
            unique="false">
            <column name="cve_id"/>
        </createIndex>

        <addForeignKeyConstraint
            baseTableName="vulnerability"
            baseColumnNames="description_id"
            referencedTableName="description"
            referencedColumnNames="description_id"
            constraintName="description_id_fk"/>
    </changeSet>
    
    <changeSet author="affectedproduct" id="affectedproduct">
        <createTable tableName="affectedproduct">
            <column name="affected_product_id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cve_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="cpe" type="VARCHAR(300)">
                <constraints nullable="false"/>
            </column>
            <column name="release_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="product_name" type="TINYTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="TINYTEXT">
                <constraints nullable="true"/>
            </column>
            <column name="vendor" type="TINYTEXT">
                <constraints nullable="true"/>
            </column>
        </createTable>

        <createIndex
            indexName="affected_product_id_index"
            tableName="affectedproduct"
            unique="false">
            <column name="affected_product_id"/>
        </createIndex>

        <addForeignKeyConstraint
            baseTableName="affectedproduct"
            baseColumnNames="cve_id"
            referencedTableName="vulnerability"
            referencedColumnNames="cve_id"
            constraintName="affectedproduct_cve_id_fk"/>
    </changeSet>

    <changeSet author="cvss" id="cvss">
        <createTable tableName="cvss">
            <column name="cve_id" type="VARCHAR(20)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="create_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="base_score" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="impact_score" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex
            indexName="cvss_cve_id_index"
            tableName="cvss"
            unique="false">
            <column name="cve_id"/>
        </createIndex>

        <addForeignKeyConstraint
            baseTableName="cvss"
            baseColumnNames="cve_id"
            referencedTableName="vulnerability"
            referencedColumnNames="cve_id"
            constraintName="cvssscore_cve_id_fk"/>
    </changeSet>

    <changeSet author="description" id="description">
        <createTable tableName="description">
            <column name="description_id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="description" type="MEDIUMTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="gpt_func" type="TINYTEXT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex
            indexName="description_index_cve_id"
            tableName="description"
            unique="false">
            <column name="cve_id"/>
        </createIndex>

        <addForeignKeyConstraint
            baseTableName="description"
            baseColumnNames="cve_id"
            referencedTableName="vulnerability"
            referencedColumnNames="cve_id"
            constraintName="description_cve_id_fk"/>
    </changeSet>

    <changeSet author="rawdescription" id="rawdescription">
        <createTable tableName="rawdescription">
            <column name="raw_description_id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="raw_description" type="MEDIUMTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="cve_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="published_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="source_url" type="TINYTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="is_garbage" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex
            indexName="raw_description_index_id"
            tableName="rawdescription"
            unique="false">
            <column name="raw_description_id"/>
        </createIndex>
    </changeSet>

    <changeSet author="rawdescriptionjt" id="rawdescriptionjt">
        <createTable tableName="rawdescriptionjt">
            <column name="description_joint_id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="description_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="raw_description_id" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex
            indexName="description_index_joint_id"
            tableName="rawdescriptionjt"
            unique="false">
            <column name="description_joint_id"/>
        </createIndex>

        <addForeignKeyConstraint
            baseTableName="rawdescriptionjt"
            baseColumnNames="description_id"
            referencedTableName="description"
            referencedColumnNames="description_id"
            constraintName="description_joint_description_id_fk"/>

        <addForeignKeyConstraint
            baseTableName="rawdescriptionjt"
            baseColumnNames="raw_description_id"
            referencedTableName="rawdescription"
            referencedColumnNames="raw_description_id"
            constraintName="description_joint_raw_description_id_fk"/>
    </changeSet>

    <changeSet author="exploit" id="exploit">
        <createTable tableName="exploit">
            <column name="exploit_id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cve_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="exploit_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="exploit_source" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex
            indexName="exploit_id_index"
            tableName="exploit"
            unique="false">
            <column name="exploit_id"/>
        </createIndex>

        <addForeignKeyConstraint
            baseTableName="exploit"
            baseColumnNames="cve_id"
            referencedTableName="vulnerability"
            referencedColumnNames="cve_id"
            constraintName="exploit_cve_id_fk"/>
    </changeSet>

    <changeSet author="nvdmitrestatus" id="nvdmitrestatus">
        <createTable tableName="nvdmitrestatus">
            <column name="nvdmitrestatus_id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cve_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="status_nvd" type="TINYTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="status_mitre" type="TINYTEXT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex
            indexName="nvdmitrestatus_id_index"
            tableName="nvdmitrestatus"
            unique="false">
            <column name="nvdmitrestatus_id"/>
        </createIndex>

        <addForeignKeyConstraint
            baseTableName="nvdmitrestatus"
            baseColumnNames="cve_id"
            referencedTableName="vulnerability"
            referencedColumnNames="cve_id"
            constraintName="nvdmitrestatus_cve_id_fk"/>
    </changeSet>

    <changeSet author="patchsourceurl" id="patchsourceurl">
        <createTable tableName="patchsourceurl">
            <column name="source_url_id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cve_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="source_url" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex
            indexName="source_url_id_index"
            tableName="patchsourceurl"
            unique="false">
            <column name="source_url_id"/>
        </createIndex>

        <addForeignKeyConstraint
            baseTableName="patchsourceurl"
            baseColumnNames="cve_id"
            referencedTableName="vulnerability"
            referencedColumnNames="cve_id"
            constraintName="patch_source_cve_id_fk"/>
    </changeSet>

    <changeSet author="patchcommit" id="patchcommit">
        <createTable tableName="patchcommit">
            <column name="commit_id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="source_url_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="commit_url" type="TINYTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="commit_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="commit_message" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex
            indexName="commit_id_index"
            tableName="patchcommit"
            unique="false">
            <column name="commit_id"/>
        </createIndex>

        <addForeignKeyConstraint
            baseTableName="patchcommit"
            baseColumnNames="source_url_id"
            referencedTableName="patchsourceurl"
            referencedColumnNames="source_url_id"
            constraintName="source_url_id_fk"/>
    </changeSet>

    <changeSet author="runhistory" id="runhistory">
        <createTable tableName="runhistory">
            <column name="runhistory_id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="run_start_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="run_end_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex
            indexName="runhistory_id_idx"
            tableName="runhistory"
            unique="false">
            <column name="runhistory_id"/>
        </createIndex>
    </changeSet>

    <changeSet author="vdocharacteristic" id="vdocharacteristic">
        <createTable tableName="vdocharacteristic">
            <column name="cve_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="vdo_label" type="VARCHAR(30)">
                <constraints nullable="false"/>
            </column>
            <column name="vdo_noun_group" type="VARCHAR(30)">
                <constraints nullable="false"/>
            </column>
            <column name="vdo_confidence" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex
            indexName="vdocharacteristic_cve_id_index"
            tableName="vdocharacteristic"
            unique="false">
            <column name="cve_id"/>
        </createIndex>

        <addForeignKeyConstraint
            baseTableName="vdocharacteristic"
            baseColumnNames="cve_id"
            referencedTableName="vulnerability"
            referencedColumnNames="cve_id"
            constraintName="vdocharacteristic_cve_id_fk"/>
    </changeSet>

    <changeSet author="vulnerabilityaggregate" id="vulnerabilityaggregate">
        <createTable tableName="vulnerabilityaggregate">
            <column name="vuln_id" type="INT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cve_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="MEDIUMTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="published_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="fixed_date" type="DATETIME">
                <constraints nullable="true"/>
            </column>
            <column name="exists_at_nvd" type="TINYTEXT">
                <constraints nullable="true"/>
            </column>
            <column name="exists_at_mitre" type="TINYTEXT">
                <constraints nullable="true"/>
            </column>
            <column name="vdo_labels" type="TINYTEXT">
                <constraints nullable="true"/>
            </column>
            <column name="vdo_label_confidences" type="TINYTEXT">
                <constraints nullable="true"/>
            </column>
            <column name="vdo_noun_groups" type="TINYTEXT">
                <constraints nullable="true"/>
            </column>
            <column name="source_urls" type="MEDIUMTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="base_scores" type="TINYTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="impact_scores" type="TINYTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="cpes" type="TINYTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="exploit_publish_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="exploit_url" type="TINYTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="runhistory_id" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex
            indexName="aggregate_vuln_id"
            tableName="vulnerabilityaggregate"
            unique="true">
            <column name="vuln_id"/>
        </createIndex>

         <createIndex
            indexName="aggregate_run_date_time_id"
            tableName="vulnerabilityaggregate"
            unique="false">
            <column name="runhistory_id"/>
        </createIndex>

        <addForeignKeyConstraint
            baseTableName="vulnerabilityaggregate"
            baseColumnNames="cve_id"
            referencedTableName="vulnerability"
            referencedColumnNames="cve_id"
            constraintName="aggregate_cve_id"/>

        <addForeignKeyConstraint
            baseTableName="vulnerabilityaggregate"
            baseColumnNames="runhistory_id"
            referencedTableName="runhistory"
            referencedColumnNames="runhistory_id"
            constraintName="aggregate_run_date_time_id"/>
    </changeSet>

    <changeSet author="cvejobtrack" id="cvejobtrack">
        <createTable tableName="cvejobtrack">
            <column name="cve_id" type="VARCHAR(20)">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
        </createTable>

        <createIndex
            indexName="cvejobtrack_index_cve_id"
            tableName="cvejobtrack"
            unique="true">
            <column name="cve_id"/>
        </createIndex>
    </changeSet>
    
    <changeSet author="nvddata" id="nvddata">
        <createTable tableName="nvddata">
            <column name="cve_id" type="VARCHAR(20)">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="published_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="TINYTEXT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex
            indexName="nvddata_index_cve_id"
            tableName="nvddata"
            unique="true">
            <column name="cve_id"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>