<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:pro="http://www.liquibase.org/xml/ns/pro" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-latest.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- <changeSet author="andrew" id="modify_is_grabage_column">
        <dropColumn tableName="rawdescription" columnName="is_garbage"/>
    
        <addColumn tableName="rawdescription">
            <column name="is_garbage" type="INT" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet> -->

    <!-- <changeSet author="andrew" id="modify_is_cveid_column">
        <addColumn tableName="description">
            <column name="cve_id" type="TINYTEXT">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet> -->

    <!-- <changeSet author="paul" id="modify_purl_column">
        <addColumn tableName="affectedproduct">
            <column name="purl" type="TINYTEXT">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet> -->

<!--    <changeSet author="richard" id="modify_swid_tag_column">-->
<!--        <addColumn tableName="affectedproduct">-->
<!--            <column name="swid_tag" type="VARCHAR(1000)">-->
<!--                <constraints nullable="true"/>-->
<!--            </column>-->
<!--        </addColumn>-->
<!--    </changeSet>-->

    <!-- <changeSet author="andrew" id="add-cve-id-unique-const">
        <addUniqueConstraint
                columnNames="cve_id"
                tableName="vulnerability"/>
        <addUniqueConstraint
                columnNames="cve_id"
                tableName="vulnerabilityaggregate"/>
        <addUniqueConstraint
                columnNames="cve_id"
                tableName="nvddata"/>
        <addUniqueConstraint
                columnNames="cve_id"
                tableName="cvejobtrack"/>
    </changeSet> -->

<!--    <changeSet author="dylan" id="modify_commit_message_column">-->
<!--        <dropColumn tableName="patchcommit" columnName="commit_message"/>-->

<!--        <addColumn tableName="patchcommit">-->
<!--            <column name="commit_message" type="VARCHAR(1000)">-->
<!--                <constraints nullable="false"/>-->
<!--            </column>-->
<!--        </addColumn>-->
<!--    </changeSet>-->

<!--    <changeSet author="dylan" id="modify_uni_diff_column">-->
<!--        <dropColumn tableName="patchcommit" columnName="uni_diff"/>-->

<!--        <addColumn tableName="patchcommit">-->
<!--            <column name="uni_diff" type="TINYTEXT">-->
<!--                <constraints nullable="false"/>-->
<!--            </column>-->
<!--        </addColumn>-->
<!--    </changeSet>-->

<!--    <changeSet author="richard" id="modify_timeline_column">-->
<!--        <dropColumn tableName="patchcommit" columnName="timeline"/>-->

<!--        <addColumn tableName="patchcommit">-->
<!--            <column name="timeline" type="TEXT">-->
<!--                <constraints nullable="false"/>-->
<!--            </column>-->
<!--        </addColumn>-->
<!--    </changeSet>-->

<!--    <changeSet author="richard" id="modify_timeToPatch_column">-->
<!--        <dropColumn tableName="patchcommit" columnName="timeToPatch"/>-->

<!--        <addColumn tableName="patchcommit">-->
<!--            <column name="timeToPatch" type="VARCHAR(50)">-->
<!--                <constraints nullable="false"/>-->
<!--            </column>-->
<!--        </addColumn>-->
<!--    </changeSet>-->

<!--    <changeSet author="richard" id="modify_linesChanged_column">-->
<!--        <dropColumn tableName="patchcommit" columnName="linesChanged"/>-->

<!--        <addColumn tableName="patchcommit">-->
<!--            <column name="linesChanged" type="INT">-->
<!--                <constraints nullable="false"/>-->
<!--            </column>-->
<!--        </addColumn>-->
<!--    </changeSet>-->

<!--    <changeSet author="dylan" id="modify_uni_diff_column_small">-->
<!--        <dropColumn tableName="patchcommit" columnName="uni_diff"/>-->

<!--        <addColumn tableName="patchcommit">-->
<!--            <column name="uni_diff" type="VARCHAR(500)">-->
<!--                <constraints nullable="false"/>-->
<!--            </column>-->
<!--        </addColumn>-->
<!--    </changeSet>-->

<!--    <changeSet author="dylan" id="patchsourceurl-cascade-on-delete">-->
<!--        <dropForeignKeyConstraint-->
<!--                baseTableName="patchsourceurl"-->
<!--                baseTableSchemaName="nvip"-->
<!--                constraintName="patch_source_cve_id_fk"-->
<!--        />-->
<!--        <addForeignKeyConstraint-->
<!--                baseTableName="patchsourceurl"-->
<!--                baseColumnNames="cve_id"-->
<!--                referencedTableName="vulnerability"-->
<!--                referencedColumnNames="cve_id"-->
<!--                constraintName="patch_source_cve_id_fk"-->
<!--                onDelete="CASCADE"-->
<!--        />-->
<!--    </changeSet>-->

<!--    <changeSet author="dylan" id="patchcommit-commit-sha">-->
<!--        <dropColumn tableName="patchcommit" columnName="commit_url"/>-->
<!--        <addColumn tableName="patchcommit">-->
<!--            <column name="commit_sha" type="TINYTEXT">-->
<!--                <constraints nullable="false" />-->
<!--            </column>-->
<!--        </addColumn>-->
<!--    </changeSet>-->

<!--    <changeSet author="dylan" id="patchcommit-commit-cve-id">-->
<!--        <addColumn tableName="patchcommit">-->
<!--            <column name="cve_id" type="VARCHAR(20)">-->
<!--                <constraints nullable="false" />-->
<!--            </column>-->
<!--        </addColumn>-->

<!--        <addForeignKeyConstraint-->
<!--                baseTableName="patchcommit"-->
<!--                baseColumnNames="cve_id"-->
<!--                referencedTableName="vulnerability"-->
<!--                referencedColumnNames="cve_id"-->
<!--                constraintName="patch_commit_cve_id_fk"-->
<!--                onDelete="CASCADE"-->
<!--        />-->
<!--    </changeSet>-->

    <changeSet author="memeee" id="affectedproduct-remove-date">
        <dropColumn tableName="affectedproduct" columnName="release_date"/>
    </changeSet>

    <changeSet id="createPermissionTable" author="memeee">
        <createTable tableName="permission">
            <column name="permission_id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="permission_name" type="varchar(45)"/>
        </createTable>
    </changeSet>

    <changeSet id="createRoleTable" author="memeee">
        <createTable tableName="role">
            <column name="role_id" type="int" autoIncrement="true">
                    <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="name" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="createUserTable" author="memeee">
        <createTable tableName="user">
            <column name="user_id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="user_name" type="varchar(45)">
                <constraints nullable="false"/>
            </column>
            <column name="password_hash" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="token" type="varchar(512)">
                <constraints nullable="true"/>
            </column>
            <column name="token_expiration_date" type="datetime">
                <constraints nullable="true"/>
            </column>
            <column name="first_name" type="varchar(50)">
                <constraints nullable="true"/>
            </column>
            <column name="last_name" type="varchar(50)">
                <constraints nullable="true"/>
            </column>
            <column name="role_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="varchar(45)">
                <constraints nullable="true"/>
            </column>
            <column name="registered_date" type="datetime">
                <constraints nullable="true"/>
            </column>
            <column name="last_login_date" type="datetime">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <addUniqueConstraint columnNames="user_name" constraintName="user_name_idx" tableName="user"/>
        <addForeignKeyConstraint baseColumnNames="role_id" baseTableName="user" constraintName="user_role"
                                 referencedColumnNames="role_id" referencedTableName="role"/>
    </changeSet>



    <changeSet id="createUserPermissionTable" author="memeee">
        <createTable tableName="userpermission">
            <column name="user_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="permission_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date" type="datetime">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="user_id, permission_id" tableName="userpermission"/>
        <addForeignKeyConstraint baseColumnNames="permission_id" baseTableName="userpermission"
                                 constraintName="userpermission_permission_id_fk"
                                 referencedColumnNames="permission_id" referencedTableName="permission"/>
        <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="userpermission"
                                 constraintName="userpermission_user_id_fk"
                                 referencedColumnNames="user_id" referencedTableName="user"/>
    </changeSet>


    <changeSet id="removeColumnsFromRunHistory" author="memeee">
        <dropColumn tableName="runhistory" columnName="run_start_date" />
        <dropColumn tableName="runhistory" columnName="run_end_date" />
    </changeSet>

    <!-- Add new columns to the existing table -->
    <changeSet id="enhanceRunHistory" author="memeee">
        <addColumn tableName="runhistory">
            <column name="run_date_time" type="datetime" />
            <column name="total_cve_count" type="int" />
            <column name="new_cve_count" type="int" />
            <column name="updated_cve_count" type="int" />
            <column name="not_in_nvd_count" type="int" />
            <column name="not_in_mitre_count" type="int" />
            <column name="not_in_both_count" type="int" />
            <column name="avg_time_gap_nvd" type="double" />
            <column name="avg_time_gap_mitre" type="double" />
        </addColumn>
    </changeSet>

    <changeSet id="dropVulnerabilityAggregate" author="dylan">
        <dropTable tableName="vulnerabilityaggregate" cascadeConstraints="true"/>
    </changeSet>

<!--    <changeSet id="renamePatchCommitColumns" author="dylan">-->
<!--        <renameColumn tableName="patchcommit" oldColumnName="timeToPatch" newColumnName="time_to_patch" columnDataType="VARCHAR(50)" />-->
<!--        <renameColumn tableName="patchcommit" oldColumnName="linesChanged" newColumnName="lines_changed" columnDataType="INT" />-->
<!--    </changeSet>-->

<!--    <changeSet id="updateNvdMitreStatus" author="dylan">-->
<!--        <renameColumn tableName="nvdmitrestatus" oldColumnName="status_mitre" newColumnName="exists_mitre" columnDataType="TINYTEXT" />-->
<!--        <renameColumn tableName="nvdmitrestatus" oldColumnName="status_nvd" newColumnName="exists_nvd" columnDataType="TINYTEXT" />-->
<!--        <modifyDataType tableName="nvdmitrestatus" columnName="exists_mitre" newDataType="INT" />-->
<!--        <modifyDataType tableName="nvdmitrestatus" columnName="exists_nvd" newDataType="INT" />-->
<!--    </changeSet>-->

    <!-- <changeSet id="addUserToCvss" author="asawtelle">
        <addColumn tableName="cvss">
            <column name="user_id" type="int">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="addUserToVdo" author="asawtelle">
        <addColumn tableName="vdocharacteristic">
            <column name="user_id" type="int">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet> -->

<!--    <changeSet id="updateCvssPrimaryKey" author="asawtelle">-->
<!--        <dropPrimaryKey-->
<!--                dropIndex="true"-->
<!--                tableName="cvss"/>-->
<!--        <addColumn tableName="cvss">-->
<!--            <column name="cvss_id" type="int" autoIncrement="true">-->
<!--                <constraints primaryKey="true" nullable="false"/>-->
<!--            </column>-->
<!--        </addColumn>-->
<!--    </changeSet>-->

    <changeSet id="dropNvdMitreStatus" author="memeee">
        <dropTable tableName="nvdmitrestatus"/>
    </changeSet>

    <changeSet id="createTimegapTable" author="memeee">
        <createTable tableName="timegap">
            <column name="timegap_id" type="int" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_timegap"/>
            </column>
            <column name="cve_id" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
            <column name="location" type="varchar(10)">
                <constraints nullable="false"/>
            </column>
            <column name="timegap" type="double">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="datetime">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex tableName="timegap" indexName="timegap_cve_id_index" unique="false">
            <column name="cve_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="timegap" baseColumnNames="cve_id"
                                 referencedTableName="vulnerability" referencedColumnNames="cve_id"
                                 constraintName="timegap_cve_id_fk"/>

        <addUniqueConstraint tableName="timegap" columnNames="cve_id, location" constraintName="uk_timegap_cve_id_location"/>

    </changeSet>

    <changeSet id="createMitreDataTable" author="memeee">
        <createTable tableName="mitredata">
            <column name="cve_id" type="VARCHAR(20)">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="status" type="TINYTEXT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex
                indexName="mitredata_index_cve_id"
                tableName="mitredata"
                unique="true">
            <column name="cve_id"/>
        </createIndex>

        <addUniqueConstraint
                columnNames="cve_id"
                tableName="nvddata"/>
    </changeSet>

    <changeSet id="addNvdLastModifiedColumn" author="memeee">
        <addColumn tableName="nvddata">
            <column name="last_modified" type="datetime">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="addMitreLastModifiedColumn" author="memeee">
        <addColumn tableName="mitredata">
            <column name="last_modified" type="datetime">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="addDescriptionUserId" author="memeee">
        <addColumn tableName="description">
            <column name="is_user_generated" type="int">
                <constraints nullable="false" defaultValue="0"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="addVdoActiveFlag" author="memeee">
        <addColumn tableName="vdocharacteristic">
            <column name="is_active" type="int">
                <constraints nullable="false" defaultValue="0"/>
            </column>
        </addColumn>
    </changeSet>


</databaseChangeLog>