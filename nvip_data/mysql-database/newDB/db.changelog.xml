<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:pro="http://www.liquibase.org/xml/ns/pro" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-latest.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- <changeSet author="andrew" id="modify_is_grabage_column">
        <dropColumn tableName="rawdescription" columnName="is_garbage"/>
    
        <addColumn tableName="rawdescription">
            <column name="is_garbage" type="INT" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet> -->

    <!-- <changeSet author="andrew" id="modify_is_cveid_column">
        <addColumn tableName="description">
            <column name="cve_id" type="TINYTEXT">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet> -->

    <!-- <changeSet author="paul" id="modify_purl_column">
        <addColumn tableName="affectedproduct">
            <column name="purl" type="TINYTEXT">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet> -->

<!--    <changeSet author="richard" id="modify_swid_tag_column">-->
<!--        <addColumn tableName="affectedproduct">-->
<!--            <column name="swid_tag" type="VARCHAR(1000)">-->
<!--                <constraints nullable="true"/>-->
<!--            </column>-->
<!--        </addColumn>-->
<!--    </changeSet>-->

    <!-- <changeSet author="andrew" id="add-cve-id-unique-const">
        <addUniqueConstraint
                columnNames="cve_id"
                tableName="vulnerability"/>
        <addUniqueConstraint
                columnNames="cve_id"
                tableName="vulnerabilityaggregate"/>
        <addUniqueConstraint
                columnNames="cve_id"
                tableName="nvddata"/>
        <addUniqueConstraint
                columnNames="cve_id"
                tableName="cvejobtrack"/>
    </changeSet> -->

<!--    <changeSet author="dylan" id="modify_commit_message_column">-->
<!--        <dropColumn tableName="patchcommit" columnName="commit_message"/>-->

<!--        <addColumn tableName="patchcommit">-->
<!--            <column name="commit_message" type="VARCHAR(1000)">-->
<!--                <constraints nullable="false"/>-->
<!--            </column>-->
<!--        </addColumn>-->
<!--    </changeSet>-->

<!--    <changeSet author="dylan" id="modify_uni_diff_column">-->
<!--        <dropColumn tableName="patchcommit" columnName="uni_diff"/>-->

<!--        <addColumn tableName="patchcommit">-->
<!--            <column name="uni_diff" type="TINYTEXT">-->
<!--                <constraints nullable="false"/>-->
<!--            </column>-->
<!--        </addColumn>-->
<!--    </changeSet>-->

<!--    <changeSet author="richard" id="modify_timeline_column">-->
<!--        <dropColumn tableName="patchcommit" columnName="timeline"/>-->

<!--        <addColumn tableName="patchcommit">-->
<!--            <column name="timeline" type="TEXT">-->
<!--                <constraints nullable="false"/>-->
<!--            </column>-->
<!--        </addColumn>-->
<!--    </changeSet>-->

<!--    <changeSet author="richard" id="modify_timeToPatch_column">-->
<!--        <dropColumn tableName="patchcommit" columnName="timeToPatch"/>-->

<!--        <addColumn tableName="patchcommit">-->
<!--            <column name="timeToPatch" type="VARCHAR(50)">-->
<!--                <constraints nullable="false"/>-->
<!--            </column>-->
<!--        </addColumn>-->
<!--    </changeSet>-->

<!--    <changeSet author="richard" id="modify_linesChanged_column">-->
<!--        <dropColumn tableName="patchcommit" columnName="linesChanged"/>-->

<!--        <addColumn tableName="patchcommit">-->
<!--            <column name="linesChanged" type="INT">-->
<!--                <constraints nullable="false"/>-->
<!--            </column>-->
<!--        </addColumn>-->
<!--    </changeSet>-->

<!--    <changeSet author="dylan" id="modify_uni_diff_column_small">-->
<!--        <dropColumn tableName="patchcommit" columnName="uni_diff"/>-->

<!--        <addColumn tableName="patchcommit">-->
<!--            <column name="uni_diff" type="VARCHAR(500)">-->
<!--                <constraints nullable="false"/>-->
<!--            </column>-->
<!--        </addColumn>-->
<!--    </changeSet>-->

<!--    <changeSet author="dylan" id="patchsourceurl-cascade-on-delete">-->
<!--        <dropForeignKeyConstraint-->
<!--                baseTableName="patchsourceurl"-->
<!--                baseTableSchemaName="nvip"-->
<!--                constraintName="patch_source_cve_id_fk"-->
<!--        />-->
<!--        <addForeignKeyConstraint-->
<!--                baseTableName="patchsourceurl"-->
<!--                baseColumnNames="cve_id"-->
<!--                referencedTableName="vulnerability"-->
<!--                referencedColumnNames="cve_id"-->
<!--                constraintName="patch_source_cve_id_fk"-->
<!--                onDelete="CASCADE"-->
<!--        />-->
<!--    </changeSet>-->

    <changeSet author="dylan" id="patchcommit-commit-sha">
        <dropColumn tableName="patchcommit" columnName="commit_url"/>
        <addColumn tableName="patchcommit">
            <column name="commit_sha" type="TINYTEXT">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet author="dylan" id="patchcommit-commit-cve-id">
        <addColumn tableName="patchcommit">
            <column name="cve_id" type="VARCHAR(20)">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addForeignKeyConstraint
                baseTableName="patchcommit"
                baseColumnNames="cve_id"
                referencedTableName="vulnerability"
                referencedColumnNames="cve_id"
                constraintName="patch_commit_cve_id_fk"
                onDelete="CASCADE"
        />
    </changeSet>

    <changeSet author="memeee" id="affectedproduct-remove-date">
        <removeColumn tableName="affectedproduct" columnName="release_date"/>
    </changeSet>

    <changeSet id="createPermissionTable" author="memeee">
        <createTable tableName="permission">
            <column name="permission_id" type="int" autoIncrement="true"
                    constraints="primaryKey"/>
            <column name="permission_name" type="varchar(45)"/>
        </createTable>
    </changeSet>

    <changeSet id="createRoleTable" author="memeee">
        <createTable tableName="role">
            <column name="role_id" type="int" autoIncrement="true"
                    constraints="primaryKey"/>
            <column name="name" type="varchar(20)" nullable="false"/>
        </createTable>
    </changeSet>

    <changeSet id="createUserTable" author="memeee">
        <createTable tableName="user">
            <column name="user_id" type="int" autoIncrement="true"
                    constraints="primaryKey"/>
            <column name="user_name" type="varchar(45)" nullable="false"/>
            <column name="password_hash" type="varchar(1024)" nullable="false"/>
            <column name="token" type="varchar(512)" nullable="true"/>
            <column name="token_expiration_date" type="datetime" nullable="true"/>
            <column name="first_name" type="varchar(50)" nullable="true"/>
            <column name="last_name" type="varchar(50)" nullable="true"/>
            <column name="role_id" type="int" nullable="false"/>
            <column name="email" type="varchar(45)" nullable="true"/>
            <column name="registered_date" type="datetime" nullable="true"/>
            <column name="last_login_date" type="datetime" nullable="true"/>

            <constraints primaryKey="user_id"/>
            <constraints uniqueConstraint="user_name_idx"
                         uniqueColumns="user_name"/>
            <constraints foreignKeyConstraint="user_role"
                         referencedTableName="role"
                         referencedColumnNames="role_id"
                         baseColumnNames="role_id"/>
        </createTable>
    </changeSet>


    <changeSet id="createUserPermissionTable" author="memeee">
        <createTable tableName="userpermission">
            <column name="user_id" type="int" nullable="false"/>
            <column name="permission_id" type="int" nullable="false"/>
            <column name="date" type="datetime" nullable="true"/>

            <constraints primaryKey="user_id,permission_id"/>
            <constraints foreignKeyConstraint="userpermission_permission_id_fk"
                         referencedTableName="permission"
                         referencedColumnNames="permission_id"
                         baseColumnNames="permission_id"/>
            <constraints foreignKeyConstraint="userpermission_user_id_fk"
                         referencedTableName="user"
                         referencedColumnNames="user_id"
                         baseColumnNames="user_id"/>
        </createTable>
    </changeSet>

</databaseChangeLog>