package fixes.urlfinders;

import edu.rit.se.nvip.db.DatabaseHelper;
import edu.rit.se.nvip.db.repositories.PatchFixRepository;
import fixes.FixFinder;

import javax.sql.DataSource;
import java.io.IOException;
import java.util.*;

/**
 *  Implementation of FixUrlFinder for CVEs collected from the NVIP Crawler
 *
 *  @author Richard Sawh
 */
public class VulnerabilityFixUrlFinder extends FixUrlFinder {

    public VulnerabilityFixUrlFinder() { }

    @Override
    public ArrayList<String> run(String cveId) throws IOException {
        logger.info("Getting fixes for CVE: {}", cveId);
        ArrayList<String> urlList = new ArrayList<>();

        // Get all sources for the cve
        DataSource ds = DatabaseHelper.getInstance().getDataSource();
        Set<String> sources = new HashSet<>( new PatchFixRepository(ds).getSpecificCveSources(cveId));

        // Test each source for a valid connection
        for (String source : sources) {
            //case for cxsecurityFinder
            if(Objects.equals(source, "https://cxsecurity.com/cvemap")){
                source = "https://cxsecurity.com/cveshow/".concat(cveId) ;
            }

            if (testConnection(source)) {
                urlList.add(source);
            }
        }
        return urlList;
    }
}